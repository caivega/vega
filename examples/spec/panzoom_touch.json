{
  "width": 800,
  "height": 500,
  "padding": {"left": 45, "right": 65, "top": 50, "bottom": 50},

  "data": [
    {
      "name": "points",
      "url": "data/points.json"
    }
  ],

  "signals": [
    {
      "name": "onetouch",
      "init": {"from0":false,"t":0,"active":false},
      "streams": [
        {"type":"touchmove,touchstart,touchend", "expr": "onetouch.active=e.touches.length==1,onetouch.from0=onetouch.active&&(onetouch.from0||onetouch.t==0),onetouch.t=e.touches.length,onetouch"}
      ]
    },
    {
      "name": "twotouchstart",
      "init": null,
      "streams": [
        {"type": "touchmove[touches!=2][e.touches.length==2]", "expr":"0"},
        {"type": "touchstart[touches!=2][e.touches.length==2]", "expr":"0"},
        {"type": "touchend[touches!=2][e.touches.length==2]", "expr":"0"}
      ]
    },
    {
      "name": "touches",
      "init": 0,
      "streams": [
        {"type": "touchmove,touchstart,touchend", "expr": "e.touches.length"}
      ]
    },
    {
      "name": "twotouchmove",
      "init": [],
      "streams": [
        {"type": "touchmove[e.touches.length==2],touchstart[e.touches.length==2],touchend[e.touches.length==2]", "expr":"[{x: p.x-e.changedTouches[0].clientX + e.touches[0].clientX, y: p.y-e.changedTouches[0].clientY + e.touches[0].clientY},{x: p.x-e.changedTouches[0].clientX + e.touches[1].clientX, y: p.y-e.changedTouches[0].clientY + e.touches[1].clientY}]"}
      ]
    },
    {
      "name": "ttm_screen",
      "init": [],
      "streams": [
        {"type": "touchmove[e.touches.length==2],touchstart[e.touches.length==2],touchend[e.touches.length==2]", "expr":"[{x: e.touches[0].clientX, y: e.touches[0].clientY},{x: e.touches[1].clientX, y: e.touches[1].clientY}]"}
      ]
    },
    {
      "name": "pinchZoomDelta",
      "init": 0,
      "streams": [
        {"type":"twotouchstart", "expr": "0"},
        {"type":"ttm_screen", "expr":"sqrt(pow(ttm_screen[0].x-ttm_screen[1].x,2) + pow(ttm_screen[0].y-ttm_screen[1].y,2))-pinchZoomDist"}
      ]
    },
    {
      "name": "pinchZoomDist",
      "init": 0,
      "streams": [
        {"type":"ttm_screen", "expr":"sqrt(pow(ttm_screen[0].x-ttm_screen[1].x,2) + pow(ttm_screen[0].y-ttm_screen[1].y,2))"}
      ]
    },
    {
      "name": "pinchZoomFactor",
      "init": 1,
      "streams": [
        {"type":"ttm_screen", "expr":"(pinchZoomDist-pinchZoomDelta)/pinchZoomDist"},
        {"type":"twotouchstart", "expr":"1"}
      ]
    },
    {
      "name": "xDelta",
      "init": 0,
      "streams": [
        {"type": "ttm_screen", "expr":"xCoord - (ttm_screen[0].x + ttm_screen[1].x)/2"},
        {"type": "mousedown,touchstart, twotouchstart", "expr": "0"},
        {"type": "[mousedown, mouseup] > mousemove,touchmove[onetouch.from0]", "expr": "xCoord - p.x"}
      ]
    },
    {
      "name": "xCoord",
      "init": 0,
      "streams": [
        {"type": "mousedown,touchstart", "expr": "p.x"},
        {"type": "[mousedown, mouseup] > mousemove,touchmove[onetouch.from0]", "expr": "p.x"},
        {"type": "ttm_screen", "expr":"(ttm_screen[0].x + ttm_screen[1].x)/2"}
      ]
    },
    {
      "name": "yDelta",
      "init": 0,
      "streams": [
        {"type": "ttm_screen", "expr":"(ttm_screen[0].y + ttm_screen[1].y)/2 - yCoord"},
        {"type": "mousedown,touchstart,twotouchstart", "expr": "0"},
        {"type": "[mousedown, mouseup] > mousemove,touchmove[onetouch.from0]", "expr": "p.y - yCoord"}
      ]
    },
    {
      "name": "yCoord",
      "init": 0,
      "streams": [
        {"type": "mousedown,touchstart", "expr": "p.y"},
        {"type": "[mousedown, mouseup] > mousemove,touchmove[onetouch.from0]", "expr": "p.y"},
        {"type": "ttm_screen", "expr":"(ttm_screen[0].y + ttm_screen[1].y)/2"}
      ]
    },
    {
      "name": "xMin",
      "init": -1.6,
      "streams": [
        {"type": "xDelta", "expr": "xMin + (xMax-xMin)*xDelta/800"},
        {"type": "wheel", "expr": "(e.wheelDelta||-e.deltaY) < 0 ? (xMin-zoomCenterX) * 1.05 + zoomCenterX : (xMin-zoomCenterX) / 1.05 + zoomCenterX"},
        {"type": "twotouchmove", "expr": "(xMin-zoomCenterX) * pinchZoomFactor + zoomCenterX + (xMax-xMin)/pinchZoomFactor*xDelta/1600"}
      ]
    },
    {
      "name": "xMax",
      "init": 1.6,
      "streams": [
        {"type": "xDelta", "expr": "xMax + (xMax-xMin)*xDelta/800"},
        {"type": "wheel", "expr": "(e.wheelDelta||-e.deltaY) < 0 ? (xMax-zoomCenterX) * 1.05 + zoomCenterX :(xMax-zoomCenterX) / 1.05 + zoomCenterX"},
        {"type": "twotouchmove", "expr": "(xMax-zoomCenterX) * pinchZoomFactor + zoomCenterX + (xMax-xMin)/pinchZoomFactor*xDelta/1600"}
      ]
    },
    {
      "name": "yMin",
      "init": -1,
      "streams": [
        {"type": "yDelta", "expr": "yMin + (yMax-yMin)*yDelta/500"},
        {"type": "wheel", "expr": "(e.wheelDelta||-e.deltaY) < 0 ? (yMin-zoomCenterY) * 1.05+zoomCenterY : (yMin-zoomCenterY) / 1.05 + zoomCenterY"},
        {"type": "twotouchmove", "expr": "(yMin-zoomCenterY) * pinchZoomFactor + zoomCenterY + (yMax-yMin)/pinchZoomFactor*yDelta/1000"}
      ]
    },
    {
      "name": "yMax",
      "init": 1,
      "streams": [
        {"type": "yDelta", "expr": "yMax + (yMax-yMin)*yDelta/500"},
        {"type": "wheel", "expr": "(e.wheelDelta||-e.deltaY) < 0 ? (yMax-zoomCenterY) * 1.05 +zoomCenterY: (yMax-zoomCenterY) / 1.05 + zoomCenterY"},
        {"type": "twotouchmove", "expr": "(yMax-zoomCenterY) * pinchZoomFactor + zoomCenterY + (yMax-yMin)/pinchZoomFactor*yDelta/1000"}
      ]
    },
    {
      "name": "zoomCenterX",
      "init": 0,
      "streams": [
        {"type": "mousemove", "expr": "p.x", "scale":"x", "invert":true},
        {"type": "twotouchmove", "expr": "(twotouchmove[0].x + twotouchmove[1].x)/2", "scale":"x", "invert":true}
      ]
    },
    {
      "name": "zoomCenterY",
      "init": 0,
      "streams": [
        {"type": "mousemove", "expr": "p.y", "scale":"y", "invert":true},
        {"type": "twotouchmove", "expr": "(twotouchmove[0].y + twotouchmove[1].y)/2", "scale":"y", "invert":true}
      ]
    }
  ],

  "scales": [
    {
      "name": "x",
      "type": "linear",
      "range": "width", "zero": false,
      "domainMin": {"signal": "xMin"},
      "domainMax": {"signal": "xMax"}
    },
    {
      "name": "y",
      "type": "linear",
      "range": "height", "zero": false,
      "domainMin": {"signal": "yMin"},
      "domainMax": {"signal": "yMax"}
    }
  ],
  "axes": [
    {"type": "x", "scale": "x", "grid": true, "layer": "back", "properties": {
      "labels": {
        "fontSize": {"value": 14}
      }

    }},
    {"type": "y", "scale": "y", "grid": true, "layer": "back", "properties": {
      "labels": {
        "fontSize": {"value": 14}
      }

    }}
  ],
  "marks": [
    {
      "type": "group",
      "properties": {
        "enter": {
          "x": {"value": 0},
          "width": {"value": 800},
          "y": {"value": 0},
          "height": {"value": 500},
          "clip": {"value": true}
        }
      },
      "marks": [
        {
          "type": "symbol",
          "properties": {
            "update": {
              "x": {"scale":"x","signal":"zoomCenterX"},
              "y": {"scale":"y","signal":"zoomCenterY"},
              "fill": {"value": "black"}
            }
          }
        },
        {
          "type": "symbol",
          "from": {"data": "points"},
          "properties": {
            "update": {
              "x": {"scale": "x", "field": "x"},
              "y": {"scale": "y", "field": "y"},
              "fill": {"value": "steelblue"}
            }
          }
        }
      ]
    }
  ]
}
